name: Community Management

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (UTC) ìŠ¤í…Œì¼ ì´ìŠˆ/PR ì²´í¬
    - cron: '0 9 * * *'
  issues:
    types: [opened]
  pull_request_target:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  stale:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - uses: actions/stale@v9
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        
        # ì´ìŠˆ ê´€ë ¨ ì„¤ì •
        stale-issue-message: |
          ðŸ‘‹ ì´ ì´ìŠˆëŠ” 30ì¼ ë™ì•ˆ í™œë™ì´ ì—†ì–´ ê³§ ë‹«íž ì˜ˆì •ìž…ë‹ˆë‹¤.
          
          ì´ìŠˆê°€ ì—¬ì „ížˆ ìœ íš¨í•˜ë‹¤ë©´:
          - ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”
          - ì¶”ê°€ ì •ë³´ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”
          - `needs-attention` ë¼ë²¨ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”
          
          ê°ì‚¬í•©ë‹ˆë‹¤! ðŸ™
        close-issue-message: |
          ðŸ”’ ì´ ì´ìŠˆëŠ” 60ì¼ ë™ì•ˆ í™œë™ì´ ì—†ì–´ ìžë™ìœ¼ë¡œ ë‹«í˜”ìŠµë‹ˆë‹¤.
          
          ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ìƒˆë¡œìš´ ì´ìŠˆë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
        days-before-stale: 30
        days-before-close: 60
        stale-issue-label: 'stale'
        
        # PR ê´€ë ¨ ì„¤ì •
        stale-pr-message: |
          ðŸ”„ ì´ PRì€ 30ì¼ ë™ì•ˆ í™œë™ì´ ì—†ì–´ ê³§ ë‹«íž ì˜ˆì •ìž…ë‹ˆë‹¤.
          
          PRì´ ì—¬ì „ížˆ ìœ íš¨í•˜ë‹¤ë©´:
          - ë¦¬ë² ì´ìŠ¤í•˜ì—¬ ìµœì‹  ìƒíƒœë¡œ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”
          - ëŒ“ê¸€ë¡œ ì§„í–‰ ìƒí™©ì„ ì•Œë ¤ì£¼ì„¸ìš”
          - ë„ì›€ì´ í•„ìš”í•˜ë©´ `help-wanted` ë¼ë²¨ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”
          
          ê°ì‚¬í•©ë‹ˆë‹¤! ðŸš€
        close-pr-message: |
          ðŸ”’ ì´ PRì€ 60ì¼ ë™ì•ˆ í™œë™ì´ ì—†ì–´ ìžë™ìœ¼ë¡œ ë‹«í˜”ìŠµë‹ˆë‹¤.
          
          ë³€ê²½ì‚¬í•­ì´ ì—¬ì „ížˆ í•„ìš”í•˜ë‹¤ë©´ ìƒˆë¡œìš´ PRì„ ìƒì„±í•´ì£¼ì„¸ìš”.
        days-before-pr-stale: 30
        days-before-pr-close: 60
        stale-pr-label: 'stale'
        
        # ì œì™¸í•  ë¼ë²¨
        exempt-issue-labels: 'pinned,security,needs-attention,good-first-issue'
        exempt-pr-labels: 'pinned,security,needs-attention,work-in-progress'
        
        # ë“œëž˜í”„íŠ¸ PR ì œì™¸
        exempt-draft-pr: true
        
        # ë§ˆì¼ìŠ¤í†¤ì´ ìžˆëŠ” ì´ìŠˆ/PR ì œì™¸
        exempt-milestones: true
        
        # í™œë™ ì œí•œ
        operations-per-run: 50

  welcome:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    
    steps:
    - name: Welcome new contributor
      uses: actions/github-script@v7
      with:
        script: |
          // ì²« ë²ˆì§¸ ì´ìŠˆì¸ì§€ í™•ì¸
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            creator: context.payload.issue.user.login,
            state: 'all'
          });
          
          if (issues.length === 1) {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ‘‹ **${context.payload.issue.user.login}ë‹˜, ì²« ë²ˆì§¸ ì´ìŠˆë¥¼ ë“±ë¡í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!**

              ðŸŽ‰ Figma Design System Q&A MCP ì„œë²„ í”„ë¡œì íŠ¸ì— ê´€ì‹¬ì„ ê°€ì ¸ì£¼ì…”ì„œ ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.

              ## ðŸ“‹ ë‹¤ìŒ ë‹¨ê³„
              - [ ] ì´ìŠˆê°€ ëª…í™•í•˜ê³  ìž¬í˜„ ê°€ëŠ¥í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”
              - [ ] ê´€ë ¨ ë¡œê·¸ë‚˜ ìŠ¤í¬ë¦°ìƒ·ì´ ìžˆë‹¤ë©´ ì¶”ê°€í•´ì£¼ì„¸ìš”
              - [ ] [ê¸°ì—¬ ê°€ì´ë“œë¼ì¸](./CONTRIBUTING.md)ì„ ì°¸ê³ í•´ì£¼ì„¸ìš”

              ## ðŸš€ ê¸°ì—¬í•˜ê³  ì‹¶ìœ¼ì‹œë‹¤ë©´
              - \`good-first-issue\` ë¼ë²¨ì´ ìžˆëŠ” ì´ìŠˆë“¤ì„ í™•ì¸í•´ë³´ì„¸ìš”
              - ì§ˆë¬¸ì´ ìžˆìœ¼ì‹œë©´ ì–¸ì œë“  ëŒ“ê¸€ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”
              - [GitHub Discussions](https://github.com/${context.repo.owner}/${context.repo.repo}/discussions)ì—ì„œ ì»¤ë®¤ë‹ˆí‹°ì™€ ì†Œí†µí•˜ì„¸ìš”

              ê°ì‚¬í•©ë‹ˆë‹¤! ðŸ™`
            });
          }

  welcome-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' && github.event.action == 'opened'
    
    steps:
    - name: Welcome first-time contributor
      uses: actions/github-script@v7
      with:
        script: |
          // ì²« ë²ˆì§¸ PRì¸ì§€ í™•ì¸
          const { data: prs } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'all',
            per_page: 100
          });
          
          const userPrs = prs.filter(pr => pr.user.login === context.payload.pull_request.user.login);
          
          if (userPrs.length === 1) {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ‰ **${context.payload.pull_request.user.login}ë‹˜ì˜ ì²« ë²ˆì§¸ ê¸°ì—¬ë¥¼ í™˜ì˜í•©ë‹ˆë‹¤!**

              ì •ë§ ê°ì‚¬í•©ë‹ˆë‹¤! ì—¬ëŸ¬ë¶„ì˜ ê¸°ì—¬ê°€ í”„ë¡œì íŠ¸ë¥¼ ë”ìš± ë°œì „ì‹œí‚µë‹ˆë‹¤. ðŸš€

              ## ðŸ“‹ PR ì²´í¬ë¦¬ìŠ¤íŠ¸
              - [ ] CI ë¹Œë“œê°€ í†µê³¼í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
              - [ ] ì½”ë“œ ë¦¬ë·° í”¼ë“œë°±ì— ì‘ë‹µí•´ì£¼ì„¸ìš”
              - [ ] í•„ìš”í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”
              - [ ] [ê¸°ì—¬ ê°€ì´ë“œë¼ì¸](./CONTRIBUTING.md)ì„ ë”°ë¼ì£¼ì„¸ìš”

              ## ðŸ‘¥ ë¦¬ë·° í”„ë¡œì„¸ìŠ¤
              - ë©”ì¸í…Œì´ë„ˆê°€ ê³§ ë¦¬ë·°ë¥¼ ì§„í–‰í•  ì˜ˆì •ìž…ë‹ˆë‹¤
              - í‰ê·  ì‘ë‹µ ì‹œê°„ì€ 2-3ì¼ìž…ë‹ˆë‹¤
              - ì§ˆë¬¸ì´ ìžˆìœ¼ì‹œë©´ ì–¸ì œë“  ëŒ“ê¸€ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”

              ë‹¤ì‹œ í•œ ë²ˆ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤! ðŸ™`
            });
          }

  label-management:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    
    steps:
    - name: Auto-label issues
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.payload.issue;
          const title = issue.title.toLowerCase();
          const body = issue.body.toLowerCase();
          const labels = [];
          
          // ìžë™ ë¼ë²¨ë§ ë¡œì§
          if (title.includes('[bug]') || body.includes('bug') || body.includes('error')) {
            labels.push('bug');
          }
          
          if (title.includes('[feature]') || body.includes('feature') || body.includes('enhancement')) {
            labels.push('enhancement');
          }
          
          if (body.includes('figma api') || body.includes('figma connector')) {
            labels.push('figma-api');
          }
          
          if (body.includes('yaml') || body.includes('ë°ì´í„° ë³€í™˜')) {
            labels.push('data-processing');
          }
          
          if (body.includes('documentation') || body.includes('ë¬¸ì„œ')) {
            labels.push('documentation');
          }
          
          if (body.includes('good first issue') || body.includes('beginner')) {
            labels.push('good-first-issue');
          }
          
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels
            });
          }

  community-stats:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: Generate community statistics
      uses: actions/github-script@v7
      with:
        script: |
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          
          // ìµœê·¼ 30ì¼ í†µê³„ ìˆ˜ì§‘
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'all',
            since: thirtyDaysAgo.toISOString(),
            per_page: 100
          });
          
          const stats = {
            totalIssues: issues.filter(i => !i.pull_request).length,
            totalPRs: issues.filter(i => i.pull_request).length,
            openIssues: issues.filter(i => !i.pull_request && i.state === 'open').length,
            closedIssues: issues.filter(i => !i.pull_request && i.state === 'closed').length,
            contributors: [...new Set(issues.map(i => i.user.login))].length
          };
          
          console.log('ðŸ“Š Community Statistics (Last 30 days):');
          console.log(`- Issues opened: ${stats.totalIssues}`);
          console.log(`- PRs opened: ${stats.totalPRs}`);
          console.log(`- Issues closed: ${stats.closedIssues}`);
          console.log(`- Active contributors: ${stats.contributors}`);
